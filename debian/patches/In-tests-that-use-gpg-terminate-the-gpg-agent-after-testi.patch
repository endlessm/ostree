From: Simon McVittie <smcv@debian.org>
Date: Thu, 31 Mar 2016 08:27:32 +0100
Subject: In tests that use gpg, terminate the gpg-agent after testing

Otherwise we leak those processes.

Signed-off-by: Simon McVittie <smcv@debian.org>
Applied-upstream: 2016.5, https://github.com/ostreedev/ostree/commit/b25ddd29ab8eb56bc1022dd38758e54dc4b2ccbe
---
 tests/test-commit-sign.sh         | 1 +
 tests/test-gpg-signed-commit.sh   | 2 ++
 tests/test-pull-mirror-summary.sh | 2 ++
 tests/test-pull-summary-sigs.sh   | 2 ++
 tests/test-remote-gpg-import.sh   | 1 +
 5 files changed, 8 insertions(+)

diff --git a/tests/test-commit-sign.sh b/tests/test-commit-sign.sh
index 8d52bca..1b153e9 100755
--- a/tests/test-commit-sign.sh
+++ b/tests/test-commit-sign.sh
@@ -132,5 +132,6 @@ if ${CMD_PREFIX} ostree --repo=repo show main | grep -o 'Found [[:digit:]] signa
 fi
 
 rm -rf repo gnomerepo-files
+gpg-connect-agent --homedir ${test_tmpdir}/gpghome killagent /bye
 
 echo "ok"
diff --git a/tests/test-gpg-signed-commit.sh b/tests/test-gpg-signed-commit.sh
index a0bf983..096c0e1 100755
--- a/tests/test-gpg-signed-commit.sh
+++ b/tests/test-gpg-signed-commit.sh
@@ -78,4 +78,6 @@ if ${OSTREE} show test2 | grep -o 'Found [[:digit:]] signature'; then
   assert_not_reached
 fi
 
+gpg-connect-agent --homedir ${test_tmpdir}/gpghome killagent /bye
+
 echo "ok"
diff --git a/tests/test-pull-mirror-summary.sh b/tests/test-pull-mirror-summary.sh
index 20707a1..d5e27fc 100755
--- a/tests/test-pull-mirror-summary.sh
+++ b/tests/test-pull-mirror-summary.sh
@@ -121,3 +121,5 @@ echo "ok pull mirror with invalid summary sig and no verification"
 # assert_file_has_content deltas.txt "${origmain}-${newmain}"
 
 # echo "ok pull mirror with signed summary covering static deltas"
+
+gpg-connect-agent --homedir ${test_tmpdir}/gpghome killagent /bye
diff --git a/tests/test-pull-summary-sigs.sh b/tests/test-pull-summary-sigs.sh
index 202efda..dd2fcb0 100755
--- a/tests/test-pull-summary-sigs.sh
+++ b/tests/test-pull-summary-sigs.sh
@@ -133,3 +133,5 @@ assert_file_has_content summary.txt "Good signature from \"Ostree Tester <test@t
 grep static-deltas summary.txt > static-deltas.txt
 assert_file_has_content static-deltas.txt \
   $(${OSTREE} --repo=repo rev-parse origin:main)
+
+gpg-connect-agent --homedir ${test_tmpdir}/gpghome killagent /bye
diff --git a/tests/test-remote-gpg-import.sh b/tests/test-remote-gpg-import.sh
index bb0c402..aa90eb8 100755
--- a/tests/test-remote-gpg-import.sh
+++ b/tests/test-remote-gpg-import.sh
@@ -143,4 +143,5 @@ if ${OSTREE} pull R2:main >/dev/null 2>&1; then
 fi
 ${OSTREE} pull R3:main >/dev/null
 
+gpg-connect-agent --homedir ${test_tmpdir}/gpghome killagent /bye
 echo "ok"
